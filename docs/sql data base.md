-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.app_members (
  user_id uuid NOT NULL,
  role USER-DEFINED NOT NULL DEFAULT 'admin'::role,
  created_at timestamp with time zone DEFAULT now(),
  name text,
  updated_at timestamp with time zone,
  technician_status text NOT NULL DEFAULT 'disponibil'::text CHECK (technician_status = ANY (ARRAY['disponibil'::text, 'ocupat'::text])),
  current_tray_id uuid,
  job_type text,
  is_active boolean DEFAULT true,
  CONSTRAINT app_members_pkey PRIMARY KEY (user_id),
  CONSTRAINT app_members_current_tray_id_fkey FOREIGN KEY (current_tray_id) REFERENCES public.trays(id)
);
CREATE TABLE public.arhiva_fise_serviciu (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  lead_id uuid NOT NULL,
  number text NOT NULL,
  date text,
  status text NOT NULL DEFAULT 'noua'::text CHECK (status = ANY (ARRAY['noua'::text, 'in_lucru'::text, 'finalizata'::text, 'comanda'::text, 'facturata'::text])),
  notes text,
  details text,
  office_direct boolean NOT NULL DEFAULT false,
  office_direct_at timestamp with time zone,
  curier_trimis boolean NOT NULL DEFAULT false,
  curier_scheduled_at timestamp with time zone,
  nu_raspunde_callback_at timestamp with time zone,
  no_deal boolean NOT NULL DEFAULT false,
  urgent boolean NOT NULL DEFAULT false,
  cash boolean NOT NULL DEFAULT false,
  card boolean NOT NULL DEFAULT false,
  global_discount_pct numeric NOT NULL DEFAULT 0,
  is_locked boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  archived_at timestamp with time zone NOT NULL DEFAULT now(),
  istoric jsonb,
  technician_details jsonb DEFAULT '[]'::jsonb,
  CONSTRAINT arhiva_fise_serviciu_pkey PRIMARY KEY (id),
  CONSTRAINT arhiva_fise_serviciu_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id)
);
CREATE TABLE public.arhiva_tray_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  arhiva_fisa_id uuid NOT NULL,
  department_id uuid,
  instrument_id uuid,
  service_id uuid,
  part_id uuid,
  technician_id uuid,
  qty numeric NOT NULL DEFAULT 1,
  notes text,
  pipeline text,
  info text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT arhiva_tray_items_pkey PRIMARY KEY (id),
  CONSTRAINT arhiva_tray_items_arhiva_fisa_id_fkey FOREIGN KEY (arhiva_fisa_id) REFERENCES public.arhiva_fise_serviciu(id),
  CONSTRAINT arhiva_tray_items_department_id_fkey FOREIGN KEY (department_id) REFERENCES public.departments(id),
  CONSTRAINT arhiva_tray_items_instrument_id_fkey FOREIGN KEY (instrument_id) REFERENCES public.instruments(id),
  CONSTRAINT arhiva_tray_items_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id),
  CONSTRAINT arhiva_tray_items_part_id_fkey FOREIGN KEY (part_id) REFERENCES public.parts(id),
  CONSTRAINT arhiva_tray_items_technician_id_fkey FOREIGN KEY (technician_id) REFERENCES auth.users(id)
);
CREATE TABLE public.audit_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  table_name text NOT NULL,
  record_id uuid NOT NULL,
  operation text NOT NULL,
  old_data jsonb,
  new_data jsonb,
  actor_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT audit_log_pkey PRIMARY KEY (id)
);
CREATE TABLE public.conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type text NOT NULL CHECK (type = ANY (ARRAY['direct'::text, 'lead'::text, 'service_file'::text, 'general'::text])),
  related_id uuid,
  title text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  last_message_at timestamp with time zone,
  CONSTRAINT conversations_pkey PRIMARY KEY (id),
  CONSTRAINT conversations_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.departments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL CHECK (name = ANY (ARRAY['reparatii'::text, 'ascutire'::text])),
  CONSTRAINT departments_pkey PRIMARY KEY (id)
);
CREATE TABLE public.instruments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  weight numeric,
  created_by uuid NOT NULL,
  created_at timestamp with time zone,
  updated_at timestamp with time zone,
  department_id uuid NOT NULL,
  pipeline uuid NOT NULL,
  active boolean DEFAULT true,
  CONSTRAINT instruments_pkey PRIMARY KEY (id),
  CONSTRAINT instruments_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.app_members(user_id),
  CONSTRAINT instruments_department_id_fkey FOREIGN KEY (department_id) REFERENCES public.departments(id),
  CONSTRAINT instruments_pipeline_fkey FOREIGN KEY (pipeline) REFERENCES public.pipelines(id)
);
CREATE TABLE public.items_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type text NOT NULL CHECK (type = ANY (ARRAY['lead'::text, 'service_file'::text, 'tray'::text])),
  item_id uuid NOT NULL,
  event_type text NOT NULL,
  message text NOT NULL,
  payload jsonb DEFAULT '{}'::jsonb,
  actor_id uuid,
  actor_name text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT items_events_pkey PRIMARY KEY (id),
  CONSTRAINT items_events_actor_id_fkey FOREIGN KEY (actor_id) REFERENCES auth.users(id)
);
CREATE TABLE public.lead_tags (
  lead_id uuid NOT NULL,
  tag_id uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT lead_tags_pkey PRIMARY KEY (lead_id, tag_id),
  CONSTRAINT lead_tags_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id),
  CONSTRAINT lead_tags_tag_id_fkey FOREIGN KEY (tag_id) REFERENCES public.tags(id)
);
CREATE TABLE public.leads (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ad_id character varying,
  ad_name character varying,
  adset_id character varying,
  adset_name character varying,
  campaign_id character varying,
  campaign_name character varying,
  form_id character varying,
  lead_id character varying UNIQUE,
  platform character varying,
  page_id character varying,
  page_name character varying,
  form_name character varying,
  full_name character varying,
  email character varying,
  phone_number character varying,
  raw_full_name character varying,
  raw_email character varying,
  raw_phone_number character varying,
  custom_disclaimer_responses text,
  partner_name character varying,
  retailer_item_id character varying,
  vehicle character varying,
  form_created_time timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  call_back boolean DEFAULT false,
  nu_raspunde boolean DEFAULT false,
  no_deal boolean DEFAULT false,
  address text,
  tray_details text,
  address2 text,
  city text,
  zip text,
  company_name text,
  company_address text,
  call_back_countdown integer DEFAULT 14,
  judet text,
  strada text,
  callback_date timestamp with time zone,
  contact_person text,
  contact_phone text,
  billing_nume_prenume text,
  billing_nume_companie text,
  billing_cui text,
  billing_strada text,
  billing_oras text,
  billing_judet text,
  billing_cod_postal text,
  details text,
  nu_raspunde_callback_at timestamp with time zone,
  follow_up_set_at timestamp with time zone,
  has_ever_been_moved boolean NOT NULL DEFAULT false,
  no_deal_at timestamp with time zone,
  curier_trimis_at timestamp with time zone,
  curier_trimis_user_id uuid,
  office_direct_at timestamp with time zone,
  office_direct_user_id uuid,
  suna_acknowledged_at timestamp with time zone,
  claimed_by uuid,
  created_by uuid,
  CONSTRAINT leads_pkey PRIMARY KEY (id),
  CONSTRAINT leads_claimed_by_fkey FOREIGN KEY (claimed_by) REFERENCES auth.users(id),
  CONSTRAINT leads_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT leads_curier_trimis_user_id_fkey FOREIGN KEY (curier_trimis_user_id) REFERENCES auth.users(id),
  CONSTRAINT leads_office_direct_user_id_fkey FOREIGN KEY (office_direct_user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  sender_id uuid NOT NULL,
  content text NOT NULL,
  message_type text NOT NULL DEFAULT 'text'::text CHECK (message_type = ANY (ARRAY['text'::text, 'file'::text, 'system'::text, 'image'::text])),
  image_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  user_id uuid,
  has_attachments boolean DEFAULT false,
  CONSTRAINT messages_pkey PRIMARY KEY (id),
  CONSTRAINT messages_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT messages_image_id_fkey FOREIGN KEY (image_id) REFERENCES public.tray_images(id),
  CONSTRAINT messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(id),
  CONSTRAINT messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES auth.users(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  type text NOT NULL,
  title text NOT NULL,
  message text NOT NULL,
  data jsonb DEFAULT '{}'::jsonb,
  read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  read_at timestamp with time zone,
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.parts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  price numeric CHECK (price >= 0::numeric),
  active boolean NOT NULL DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  model text,
  CONSTRAINT parts_pkey PRIMARY KEY (id),
  CONSTRAINT parts_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.pipeline_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type text NOT NULL,
  item_id uuid NOT NULL,
  pipeline_id uuid NOT NULL,
  stage_id uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT pipeline_items_pkey PRIMARY KEY (id),
  CONSTRAINT pipeline_items_stage_id_fkey FOREIGN KEY (stage_id) REFERENCES public.stages(id),
  CONSTRAINT pipeline_items_pipeline_id_fkey FOREIGN KEY (pipeline_id) REFERENCES public.pipelines(id)
);
CREATE TABLE public.pipelines (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL UNIQUE,
  description text,
  position integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT pipelines_pkey PRIMARY KEY (id),
  CONSTRAINT pipelines_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.push_subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  endpoint text NOT NULL UNIQUE,
  p256dh text NOT NULL,
  auth text NOT NULL,
  user_agent text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT push_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT push_subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.service_files (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  lead_id uuid NOT NULL,
  number text NOT NULL,
  date date NOT NULL,
  status text NOT NULL DEFAULT 'noua'::text,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  office_direct boolean DEFAULT false,
  curier_trimis boolean DEFAULT false,
  no_deal boolean,
  details text,
  urgent boolean,
  cash boolean,
  card boolean,
  global_discount_pct numeric DEFAULT 0,
  is_locked boolean DEFAULT false,
  curier_scheduled_at timestamp with time zone,
  nu_raspunde_callback_at timestamp with time zone,
  office_direct_at timestamp with time zone,
  technician_details jsonb DEFAULT '[]'::jsonb,
  colet_neridicat boolean NOT NULL DEFAULT false,
  retur boolean DEFAULT false,
  archived_at timestamp with time zone,
  colet_ridicat boolean,
  subscription_type text DEFAULT ''::text,
  colet_ajuns boolean DEFAULT false,
  CONSTRAINT service_files_pkey PRIMARY KEY (id),
  CONSTRAINT service_files_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id)
);
CREATE TABLE public.services (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  price numeric NOT NULL CHECK (price >= 0::numeric),
  active boolean NOT NULL DEFAULT true,
  created_by uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  time integer,
  instrument_id uuid NOT NULL,
  department_id uuid NOT NULL,
  CONSTRAINT services_pkey PRIMARY KEY (id),
  CONSTRAINT services_department_id_fkey FOREIGN KEY (department_id) REFERENCES public.departments(id),
  CONSTRAINT services_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT services_instrument_id_fkey FOREIGN KEY (instrument_id) REFERENCES public.instruments(id)
);
CREATE TABLE public.stage_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  lead_id uuid,
  pipeline_id uuid NOT NULL,
  from_stage_id uuid,
  to_stage_id uuid NOT NULL,
  moved_by uuid,
  moved_at timestamp with time zone DEFAULT now(),
  notes text,
  tray_id uuid,
  service_file_id uuid,
  CONSTRAINT stage_history_pkey PRIMARY KEY (id),
  CONSTRAINT stage_history_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id),
  CONSTRAINT stage_history_pipeline_id_fkey FOREIGN KEY (pipeline_id) REFERENCES public.pipelines(id),
  CONSTRAINT stage_history_from_stage_id_fkey FOREIGN KEY (from_stage_id) REFERENCES public.stages(id),
  CONSTRAINT stage_history_to_stage_id_fkey FOREIGN KEY (to_stage_id) REFERENCES public.stages(id),
  CONSTRAINT stage_history_service_file_id_fkey FOREIGN KEY (service_file_id) REFERENCES public.service_files(id),
  CONSTRAINT stage_history_tray_id_fkey FOREIGN KEY (tray_id) REFERENCES public.trays(id)
);
CREATE TABLE public.stages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  pipeline_id uuid NOT NULL,
  name character varying NOT NULL,
  position integer,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  color text,
  config jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT stages_pkey PRIMARY KEY (id),
  CONSTRAINT stages_pipeline_id_fkey FOREIGN KEY (pipeline_id) REFERENCES public.pipelines(id)
);
CREATE TABLE public.tags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  color text NOT NULL CHECK (color = ANY (ARRAY['green'::text, 'yellow'::text, 'red'::text, 'orange'::text, 'blue'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT tags_pkey PRIMARY KEY (id)
);
CREATE TABLE public.technician_work_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tray_id uuid,
  technician_id uuid NOT NULL,
  started_at timestamp with time zone DEFAULT now(),
  finished_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  notes text,
  CONSTRAINT technician_work_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT technician_work_sessions_tray_id_fkey FOREIGN KEY (tray_id) REFERENCES public.trays(id)
);
CREATE TABLE public.tray_images (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tray_id uuid NOT NULL,
  url text NOT NULL,
  file_path text NOT NULL,
  filename text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tray_images_pkey PRIMARY KEY (id),
  CONSTRAINT tray_images_tray_id_fkey FOREIGN KEY (tray_id) REFERENCES public.trays(id)
);
CREATE TABLE public.tray_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tray_id uuid NOT NULL,
  department_id uuid NOT NULL,
  instrument_id uuid NOT NULL,
  service_id uuid,
  qty integer NOT NULL DEFAULT 1,
  notes text,
  guaranty boolean,
  pipeline text,
  created_at timestamp with time zone,
  updated_at timestamp with time zone,
  created_by uuid,
  part_id uuid,
  technician2_id uuid,
  technician3_id uuid,
  discount real,
  non_repairable_qty integer NOT NULL DEFAULT 0,
  technician_id uuid,
  serials text,
  qtyi smallint,
  unrepaired_qty integer NOT NULL DEFAULT 0,
  CONSTRAINT tray_items_pkey PRIMARY KEY (id),
  CONSTRAINT tray_items_part_id_fkey FOREIGN KEY (part_id) REFERENCES public.parts(id),
  CONSTRAINT tray_items_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.app_members(user_id),
  CONSTRAINT tray_items_technician_id_fkey FOREIGN KEY (technician_id) REFERENCES public.app_members(user_id),
  CONSTRAINT tray_items_technician2_id_fkey FOREIGN KEY (technician2_id) REFERENCES public.app_members(user_id),
  CONSTRAINT tray_items_technician3_id_fkey FOREIGN KEY (technician3_id) REFERENCES public.app_members(user_id),
  CONSTRAINT tray_items_tray_id_fkey FOREIGN KEY (tray_id) REFERENCES public.trays(id),
  CONSTRAINT tray_items_department_id_fkey FOREIGN KEY (department_id) REFERENCES public.departments(id),
  CONSTRAINT tray_items_instrument_id_fkey FOREIGN KEY (instrument_id) REFERENCES public.instruments(id),
  CONSTRAINT tray_items_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id)
);
CREATE TABLE public.trays (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  number text NOT NULL,
  service_file_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'in_receptie'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  availability_status text NOT NULL DEFAULT 'disponibil'::text CHECK (availability_status = ANY (ARRAY['disponibil'::text, 'indisponibil'::text, 'assigned'::text, 'finished'::text])),
  unavailable_reason text,
  waiting_since timestamp with time zone,
  priority integer NOT NULL DEFAULT 0,
  technician_id uuid,
  technician2_id uuid,
  technician3_id uuid,
  parent_tray_id uuid,
  updated_at timestamp with time zone,
  size text,
  qc_notes text,
  CONSTRAINT trays_pkey PRIMARY KEY (id),
  CONSTRAINT trays_technician2_id_fkey FOREIGN KEY (technician2_id) REFERENCES public.app_members(user_id),
  CONSTRAINT trays_technician_id_fkey FOREIGN KEY (technician_id) REFERENCES public.app_members(user_id),
  CONSTRAINT trays_service_file_id_fkey FOREIGN KEY (service_file_id) REFERENCES public.service_files(id),
  CONSTRAINT trays_technician3_id_fkey FOREIGN KEY (technician3_id) REFERENCES public.app_members(user_id),
  CONSTRAINT trays_parent_tray_id_fkey FOREIGN KEY (parent_tray_id) REFERENCES public.trays(id)
);
CREATE TABLE public.user_pipeline_permissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  pipeline_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_pipeline_permissions_pkey PRIMARY KEY (id),
  CONSTRAINT user_pipeline_permissions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT user_pipeline_permissions_pipeline_id_fkey FOREIGN KEY (pipeline_id) REFERENCES public.pipelines(id)
);
CREATE TABLE public.user_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  preferences jsonb NOT NULL DEFAULT '{}'::jsonb,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT user_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.vanzari_apeluri (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  lead_id uuid NOT NULL,
  pipeline_id uuid NOT NULL,
  from_stage_id uuid NOT NULL,
  to_stage_id uuid NOT NULL,
  moved_by uuid,
  apel_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT vanzari_apeluri_pkey PRIMARY KEY (id),
  CONSTRAINT vanzari_apeluri_moved_by_fkey FOREIGN KEY (moved_by) REFERENCES auth.users(id)
);